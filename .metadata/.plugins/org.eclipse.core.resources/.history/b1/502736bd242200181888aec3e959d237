package com.capgemini.Airline.dao;

import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;

import org.apache.log4j.Logger;

import com.capgemini.Airline.bean.CustomerBean;
import com.capgemini.Airline.bean.SeatBooking;
import com.mysql.jdbc.Driver;

public class CustomerBookingDAO implements ICustomerBookingDAO {
	final static Logger logger=Logger.getLogger(CustomerBookingDAO.class);
@Override
public int addCustomerDetails(CustomerBean bean) {
	int cid=bean.getCid();
	String cname=bean.getCname();
	String email=bean.getEmail();
	String caddr=bean.getCaddr();
	long cmob=bean.getCmob();
	String cseattype=bean.getCseattype();
	int cseatnum=bean.getCseatnum();
	Connection con = null;
	PreparedStatement pstmt = null;
	try
	{
		java.sql.Driver driverRef = new Driver();
		DriverManager.registerDriver(driverRef);
		
		String dbUrl = "jdbc:mysql://localhost:3306/capsdb?user=root&password=root";
		con = DriverManager.getConnection(dbUrl);

		String query = "INSERT INTO CustomerDetails values(?,?,?,?,?,?,?)";
		if (cseatnum==25 || cseatnum==26 || cseatnum==27 || cseatnum==45 || cseatnum==46 || cseatnum==47)
		{
		pstmt = con.prepareStatement(query);
		pstmt.setInt(1, cid);
		pstmt.setString(2, cname);
		pstmt.setString(3, email);
		pstmt.setString(4, caddr);
		pstmt.setLong(5, cmob);
		pstmt.setString(6, cseattype);
		pstmt.setInt(7,cseatnum);
		
		int count=pstmt.executeUpdate();

		if(count > 0)
		{
			String query2="UPDATE SeatDetail SET Status='Booked' WHERE SeatNo=?";
			pstmt=con.prepareStatement(query2);
			pstmt.setInt(1, cseatnum);
			int count1=pstmt.executeUpdate();
			if(count1>0)
			System.out.println("Your Seat has been successfully booked, your Customer ID is: "+cid);
			else
				System.out.println("Failed to book Seat");
		}
		else
		{
			System.out.println("Failed to Book Seat");
		}
	}
		else
		{
			logger.warn("Invalid seat number selected");
			System.out.println("Invalid Seat Number");
		}
	}
	catch(Exception e)
	{
		e.printStackTrace();
		logger.error("SQL error");
	}
	finally
	{
		try
		{
			if(pstmt != null)
			{
				pstmt.close();
			}
			if(con != null)
			{
				con.close();
			}
			logger.info("JDBC Objects closed");
		}
		catch(Exception e)
		{
			e.printStackTrace();
			logger.error("Exception while closing jdbc objects");
		}
	}	
	return cid;
}
@Override
public SeatBooking getBookingDetails(int CustomerID) {
	int cid=CustomerID;
	Connection con=null;
	java.sql.PreparedStatement pstmt=null;
	java.sql.PreparedStatement pstmt1=null;
	ResultSet rs=null;
	ResultSet rs1=null;
	SeatBooking sb=new SeatBooking();
	try
	{
		java.sql.Driver driverRef = new Driver();
		DriverManager.registerDriver(driverRef);

		String dbURL = "jdbc:mysql://localhost:3306/capsdb?user=root&password=root";
		con = DriverManager.getConnection(dbURL);

		String query="SELECT * FROM CustomerDetails where custID=?";
		pstmt=con.prepareStatement(query);
		pstmt.setInt(1, cid);
		rs=pstmt.executeQuery();

		if (rs.next())
		{
			String cname=rs.getString("CustName");
			int sno=rs.getInt("SeatNo");
			String stype=rs.getString("SeatType");
			String query1="SELECT * FROM SeatDetail WHERE SeatNo=?";
			pstmt1=con.prepareStatement(query1);
			pstmt1.setInt(1, sno);
			rs1=pstmt1.executeQuery();
			String status = null;
			if(rs1.next())
			{
				status=rs1.getString("Status");
			}
			System.out.println("Name of the Customer : "+cname);
			System.out.println("Booking Status : "+status);
			System.out.println("Room Number : "+sno);
			System.out.println("Room Type : "+stype);
			sb.seatDetails(sno,stype,status);
		}
	}
	catch(Exception e)
	{
		e.printStackTrace();
	}
	finally
	{
		try
		{
			con.close();
		}
		catch (SQLException e)
		{
			e.printStackTrace();
		}
		try
		{
			if(pstmt!=null)
			pstmt.close();
			if(pstmt1!=null)
			pstmt1.close();
			logger.info("JDBC Objects closed");
		}
		catch (SQLException e)
		{
			e.printStackTrace();
			logger.error("Exception while closing jdbc objects");
		}
	}
	return sb;
}	
}